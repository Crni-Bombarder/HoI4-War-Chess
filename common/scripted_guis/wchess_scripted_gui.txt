@B_KING   = 1
@W_KING   = 2
@B_QUEEN  = 3
@W_QUEEN  = 4
@B_BISHOP = 5
@W_BISHOP = 6
@B_ROOK   = 7
@W_ROOK   = 8
@B_KNIGHT = 9
@W_KNIGHT = 10
@B_PAWN   = 11
@W_PAWN   = 12
@EMPTY    = 13

@ID_KING   = 0
@ID_QUEEN  = 1
@ID_BISHOP = 2
@ID_ROOK   = 3
@ID_KNIGHT = 4
@ID_PAWN   = 5

@BLACK = 0
@WHITE = 1

@ACTIVATE = 1
@DEACTIVATE = 2

@S_SELECTION = 0
@S_MOVE      = 1

scripted_gui = {
    wchess_scripted_gui_board = {
        window_name = "wchess_gui_board"

        context_type = player_context

        visible = {
            has_variable = wchess_start_game
        }

        dynamic_lists = {
            wchess_grid_pieces = {
                array = wchess_pieces_array
                change_scope = no
                entry_container = wchess_piece_cell
            }

            wchess_grid_highlights = {
                array = wchess_highlights_array
                change_scope = no
                entry_container = wchess_highlight_cell
            }

            wchess_grid_halochecks = {
                array = wchess_halochecks_array
                change_scope = no
                entry_container = wchess_halocheck_cell
            }
        }

        effects = {
            wchess_piece_tile_click = {

                # Debug
                log = "Event click on [?i], piece [?v] [?wchess_play_state]"

                if = {
                    limit = {
                        has_variable = wchess_game_turn
                    }

                    # State : Piece / Pawn selection
                    if = {
                        limit = {
                            check_variable = {
                                wchess_play_state = @S_SELECTION
                            }
                        }

                        if = {
                            # Select one of your piece
                            limit = {
                                check_variable = {
                                    var = wchess_pieces_array^i
                                    value = @EMPTY
                                    compare = not_equals
                                }
                                set_temp_variable = {
                                    temp_wchess_check_color_piece = wchess_pieces_array^i
                                }
                                subtract_from_temp_variable = {temp_wchess_check_color_piece = 1}
                                modulo_temp_variable = {temp_wchess_check_color_piece = 2}
                                check_variable = {
                                    temp_wchess_check_color_piece = wchess_color
                                }
                            }

                            set_temp_variable    = {temp_wchess_piece_type = wchess_pieces_array^i}
                            subtract_from_temp_variable = {temp_wchess_piece_type = 1}
                            divide_temp_variable = {temp_wchess_piece_type = 2}
                            add_to_temp_variable = {temp_wchess_piece_type = -0.5}
                            round_temp_variable  = temp_wchess_piece_type

                            clear_temp_array = temp_wchess_piece_array
                            resize_temp_array = {
                                array = temp_wchess_piece_array
                                value = 4
                                size = 64
                            }
                            for_each_loop = {
                                array = wchess_pieces_array
                                value = val
                                index = iter
                                set_temp_variable = {temp_wchess_piece_array^iter = val}
                            }
                            clear_temp_array = temp_wchess_highlights_array
                            resize_temp_array = {
                                array = temp_wchess_highlights_array
                                value = 4
                                size = 64
                            }
                            set_temp_variable = {temp_wchess_id = i}
                            set_temp_variable = {temp_wchess_color = wchess_color}

                            if = {
                                limit = {
                                    check_variable = {
                                        temp_wchess_piece_type = @ID_KING
                                    }
                                }
                                wchess_get_king_moves = yes

                            } else_if = {
                                limit = {
                                    check_variable = {
                                        temp_wchess_piece_type = @ID_QUEEN
                                    }
                                }
                                wchess_get_queen_moves = yes

                            } else_if = {
                                limit = {
                                    check_variable = {
                                        temp_wchess_piece_type = @ID_BISHOP
                                    }
                                }
                                wchess_get_bishop_moves = yes

                            } else_if = {
                                limit = {
                                    check_variable = {
                                        temp_wchess_piece_type = @ID_ROOK
                                    }
                                }
                                wchess_get_rook_moves = yes

                            } else_if = {
                                limit = {
                                    check_variable = {
                                        temp_wchess_piece_type = @ID_KNIGHT
                                    }
                                }
                                wchess_get_knight_moves = yes

                            } else_if = {
                                limit = {
                                    check_variable = {
                                        temp_wchess_piece_type = @ID_PAWN
                                    }
                                }
                                wchess_get_pawn_moves = yes
                            }
                            for_each_loop = {
                                array = wchess_highlights_array
                                value = val
                                index = iter
                                set_variable = {wchess_highlights_array^iter = temp_wchess_highlights_array^iter}
                            }

                            set_variable = {wchess_selected_id = i}
                            set_variable = {wchess_play_state  = @S_MOVE}

                            set_variable = {wchess_highlights_array^i = @ACTIVATE}
                        }
                    } else_if = {
                        limit = {
                            check_variable = {
                                wchess_play_state = @S_MOVE
                            }
                        }

                        if = {
                            # Deselect the piece
                            limit = {
                                check_variable = {
                                    wchess_selected_id = i
                                }
                            }

                            set_variable = {wchess_play_state  = @S_SELECTION}
                            clear_array = wchess_highlights_array
                            resize_array = {
                                array = wchess_highlights_array
                                size = 64
                                value = @DEACTIVATE
                            }
                        }
                    }
                }
            }
        }

        properties = {
            wchess_piece_tile = {
                frame = v
            }

            wchess_highlight_tile = {
                frame = v
            }

            wchess_halocheck_tile = {
                frame = v
            }
        }
    }

    # ########################################## #
    # ################# DEBUG ################## #
    # ########################################## #

    wchess_scripted_gui_debug = {
        window_name = "wchess_debug_interface"

        context_type = player_context

        visible = {
            has_variable = wchess_start_game
        }

        effects = {

            wchess_debug_random_tile_array_click = {
                log = "Random value to array wchess_pieces_array"
                resize_array = {
                    array = wchess_pieces_array
                    size = 64
                    value = 2
                }
                for_each_loop = {
                    array = wchess_pieces_array
                    index = i
                    set_temp_variable = {temp_random = random}
                    multiply_temp_variable = {
                        var = temp_random
                        value = 13.5
                    }
                    round_temp_variable = temp_random
                    clamp_temp_variable = {
                        var = temp_random
                        min = 0
                        max = 13
                    }

                    set_variable = {wchess_pieces_array^i = temp_random}
                }
            }

            wchess_debug_clean_tile_array_click = {
                log = "Clearing wchess_pieces_array"
                clear_array = wchess_pieces_array
            }

            wchess_debug_add_highlight_array_click = {
                wchess_create_board = yes
            }

            wchess_debug_clean_highlight_array_click = {
                log = "Clearing wchess_highlights_array"
                clear_array = wchess_highlights_array
                resize_array = {
                    array = wchess_highlights_array
                    size = 64
                    value = @DEACTIVATE
                }
            }

            wchess_debug_add_halocheck_array_click = {
                set_variable = {wchess_play_state = @S_SELECTION}
                clear_variable = wchess_selected_id
            }

            wchess_debug_clean_halocheck_array_click = {
                log = "Clearing wchess_halochecks_array"
                clear_array = wchess_halochecks_array
            }
        }
    }
}
